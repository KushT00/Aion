# AION Workflow Engine Specification

The Workflow Engine is the core runtime that executes the JSON DAG (Directed Acyclic Graph) generated by the builder.

## 1. Workflow Schema
Workflows are represented as a JSON object:
```json
{
  "id": "workflow_uuid",
  "name": "Market Researcher",
  "trigger": { "type": "webhook", "config": {} },
  "nodes": [
    { "id": "n1", "type": "ai", "action": "chat", "data": { "prompt": "{{trigger.body.query}}" } },
    { "id": "n2", "type": "notion", "action": "append", "data": { "content": "{{n1.output}}" } }
  ],
  "edges": [
    { "source": "n1", "target": "n2" }
  ]
}
```

## 2. The Execution Loop
1. **Trigger**: An event starts the execution.
2. **Context Initialization**: Create a scoped object containing environment variables and trigger data.
3. **Traversal**: Visit nodes based on their dependencies (edges).
4. **Node Resolution**:
   - Parse mustache templates (e.g., `{{node_id.output}}`).
   - Call the integration's execution function.
   - Update the context with node results.
5. **Logging**: Stream status (`pending`, `running`, `success`, `error`) to Supabase Realtime.

## 3. Key Components
- **DAG Runner**: Ensures nodes are executed in the correct topological order.
- **Variable Resolver**: Handles data passing between nodes using a flattened context.
- **Retrier**: Exponential backoff for API calls.
- **Timeout Manager**: Kills runs exceeding 10 minutes (configurable).

## 4. Run History
Every run is stored in the `runs` table:
- `run_id`: UUID
- `workflow_id`: FK
- `status`: enum (success, failed, partial)
- `logs`: JSONB (step-by-step trace)
- `execution_time`: ms
- `cost`: numeric (calculated based on AI token usage)
